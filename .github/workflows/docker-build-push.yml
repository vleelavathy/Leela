name: Docker Build & Push to ACR

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Select the environment"
        required: true
        type: choice
        options:
          - dev
          - stg
          - prd

permissions:
  id-token: write
  contents: read

env:
  REGISTRY_NAME: westus2devacr
  IMAGE_NAME: currency-dashboard
  DOCKERFILE_PATH: .github/docker/Dockerfile
  SOURCE_LOCATION: ./currency-dashboard

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    env:
      ENVIRONMENT: ${{ github.event.inputs.environment }}

    steps:
      # -------------------------
      # Checkout
      # -------------------------
      - uses: actions/checkout@v4

      # -------------------------
      # Fix Docker context (important)
      # -------------------------
      - name: Reset Docker context
        run: |
          unset DOCKER_CONTEXT || true
          rm -rf ~/.docker/contexts || true
          docker context use default || true

      # -------------------------
      # Azure Login (OIDC)
      # -------------------------
      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ vars.ARM_CLIENT_ID }}
          tenant-id: ${{ vars.ARM_TENANT_ID }}
          subscription-id: ${{ vars.ARM_SUBSCRIPTION_ID }}

      # -------------------------
      # Validate paths
      # -------------------------
      - name: Validate paths
        run: |
          set -euo pipefail
          echo "Checking Dockerfile..."
          test -f "${DOCKERFILE_PATH}"
          echo "Checking build context..."
          test -d "${SOURCE_LOCATION}"
          ls -la "${SOURCE_LOCATION}"

      # -------------------------
      # Get ACR login server
      # -------------------------
      - name: Get ACR login server
        id: acr
        run: |
          ACR_LOGIN_SERVER=$(az acr show \
            --name "${REGISTRY_NAME}" \
            --query loginServer -o tsv)

          echo "acr_login_server=${ACR_LOGIN_SERVER}" >> $GITHUB_OUTPUT

      # -------------------------
      # Login to ACR using token
      # -------------------------
      - name: Login to ACR
        run: |
          TOKEN=$(az acr login \
            --name "${REGISTRY_NAME}" \
            --expose-token \
            --query accessToken -o tsv)

          echo "$TOKEN" | docker login \
            "${{ steps.acr.outputs.acr_login_server }}" \
            --username 00000000-0000-0000-0000-000000000000 \
            --password-stdin

      # -------------------------
      # Setup buildx
      # -------------------------
        
      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      # -------------------------
      # Build & Push
      # -------------------------
      - name: Build and Push image
        run: |
          REG="${{ steps.acr.outputs.acr_login_server }}"

          docker buildx build \
            --file "${DOCKERFILE_PATH}" \
            --tag "${REG}/${IMAGE_NAME}:${GITHUB_SHA}" \
            --tag "${REG}/${IMAGE_NAME}:latest" \
            --tag "${REG}/${IMAGE_NAME}:${ENVIRONMENT}-latest" \
            --push \
            "${SOURCE_LOCATION}"

      # -------------------------
      # Output
      # -------------------------
      - name: Output image info
        run: |
          echo "âœ… Image pushed successfully"
          echo "${{ steps.acr.outputs.acr_login_server }}/${IMAGE_NAME}:${GITHUB_SHA}"
          echo "${{ steps.acr.outputs.acr_login_server }}/${IMAGE_NAME}:latest"
          echo "${{ steps.acr.outputs.acr_login_server }}/${IMAGE_NAME}:${ENVIRONMENT}-latest"
