name: Docker Build & Push to ACR

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Select the environment'
        required: true
        type: choice
        options:
          - dev
          - stg
          - prd

permissions:
  id-token: write
  contents: read

env:
  REGISTRY_NAME: westus2devacr
  IMAGE_NAME: currency-dashboard
  DOCKERFILE_PATH: currency-dashboard/dockerFile
  DOCKER_CONTEXT: currency-dashboard/
  

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    env:
      ENVIRONMENT: ${{ github.event.inputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ vars.ARM_CLIENT_ID }}
          tenant-id: ${{ vars.ARM_TENANT_ID }}
          subscription-id: ${{ vars.ARM_SUBSCRIPTION_ID }}

      - name: Get ACR Login Credentials
        id: acr-login
        run: |
          # Get ACR login server and credentials
          ACR_LOGIN_SERVER=$(az acr show \
            --name ${{ env.REGISTRY_NAME }} \
            --query loginServer \
            --output tsv)
          
          echo "acr_login_server=${ACR_LOGIN_SERVER}" >> $GITHUB_OUTPUT
          
          # Generate ACR access token
          ACR_TOKEN=$(az acr login \
            --name ${{ env.REGISTRY_NAME }} \
            --expose-token \
            --output tsv \
            --query accessToken)
          
          echo "acr_token=${ACR_TOKEN}" >> $GITHUB_OUTPUT

      - name: Echo Current Location
        run: |
          echo "Current working directory:"
          pwd
          echo ""
          echo "Directory contents:"
          ls -la
        #   echo "change directory to Docker context: ${{ env.DOCKER_CONTEXT }}"
        #   cd currency-dashboard/

      - name: Build Docker Image
        run: |
          docker build -f currency-dashboard/Dockerfile -t ${{ env.IMAGE_NAME }} currency-dashboard/


      - name: Build and Push Docker Image using Azure CLI
        run: |
          az acr build \
            --registry ${{ env.REGISTRY_NAME }} \
            --image ${{ env.IMAGE_NAME }}:${{ github.sha }} \
            --image ${{ env.IMAGE_NAME }}:latest \
            --image ${{ env.IMAGE_NAME }}:${{ env.ENVIRONMENT }}-latest \
            --file ${{ env.DOCKERFILE_PATH }} \
            ${{ env.DOCKER_CONTEXT }}

      - name: Output Image Information
        run: |
          echo "âœ… Docker image successfully built and pushed to ACR"
          echo ""
          echo "Image Details:"
          echo "  Registry: ${{ steps.acr-login.outputs.acr_login_server }}"
          echo "  Image: ${{ env.IMAGE_NAME }}"
          echo "  Tags:"
          echo "    - ${{ steps.acr-login.outputs.acr_login_server }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
          echo "    - ${{ steps.acr-login.outputs.acr_login_server }}/${{ env.IMAGE_NAME }}:latest"
          echo "    - ${{ steps.acr-login.outputs.acr_login_server }}/${{ env.IMAGE_NAME }}:${{ env.ENVIRONMENT }}-latest"
          echo ""
          echo "Next Steps to Update Container App:"
          echo "1. Use the command below to update the Container App with the latest image:"
          echo ""
          echo "   az containerapp update \\"
          echo "     --resource-group <resource-group-name> \\"
          echo "     --name <container-app-name> \\"
          echo "     --image ${{ steps.acr-login.outputs.acr_login_server }}/${{ env.IMAGE_NAME }}:latest"
