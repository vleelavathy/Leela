name: Docker Build & Push to ACR

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Select the environment'
        required: true
        type: choice
        options:
          - dev
          - stg
          - prd

permissions:
  id-token: write
  contents: read

env:
  REGISTRY_NAME: westus2devacr
  IMAGE_NAME: currency-dashboard
  DOCKERFILE_PATH: .github/docker/Dockerfile
  SOURCE_LOCATION: ./currency-dashboard

  

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    env:
      ENVIRONMENT: ${{ github.event.inputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ vars.ARM_CLIENT_ID }}
          tenant-id: ${{ vars.ARM_TENANT_ID }}
          subscription-id: ${{ vars.ARM_SUBSCRIPTION_ID }}

      - name: Get ACR Login Credentials
        id: acr-login
        run: |
          # Get ACR login server and credentials
          ACR_LOGIN_SERVER=$(az acr show \
            --name ${{ env.REGISTRY_NAME }} \
            --query loginServer \
            --output tsv)
          
          echo "acr_login_server=${ACR_LOGIN_SERVER}" >> $GITHUB_OUTPUT
          
          # Generate ACR access token
          ACR_TOKEN=$(az acr login \
            --name ${{ env.REGISTRY_NAME }} \
            --expose-token \
            --output tsv \
            --query accessToken)
          
          echo "acr_token=${ACR_TOKEN}" >> $GITHUB_OUTPUT

      - name: Validate paths
        shell: bash
        run: |
          set -e
          echo "PWD: $(pwd)"
          echo "Listing repo root:"
          ls -la
          echo ""
          echo "Listing currency-dashboard folder:"
          ls -la currency-dashboard
          echo ""
          echo "Dockerfile path: $DOCKERFILE_PATH"
          test -f "$DOCKERFILE_PATH"


      - name: Build & Push image using ACR Build
        shell: bash
        run: |
          set -euo pipefail
          echo "Building from SOURCE_LOCATION=${SOURCE_LOCATION}"
          az acr build \
            --registry "${REGISTRY_NAME}" \
            --image "${IMAGE_NAME}:${GITHUB_SHA}" \
            --image "${IMAGE_NAME}:latest" \
            --image "${IMAGE_NAME}:${ENVIRONMENT}-latest" \
            --file "${DOCKERFILE_PATH}" \
            "${SOURCE_LOCATION}"

      - name: Output Image Information
        run: |
          echo "âœ… Docker image successfully built and pushed to ACR"
          echo ""
          echo "Image Details:"
          echo "  Registry: ${{ steps.acr-login.outputs.acr_login_server }}"
          echo "  Image: ${{ env.IMAGE_NAME }}"
          echo "  Tags:"
          echo "    - ${{ steps.acr-login.outputs.acr_login_server }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
          echo "    - ${{ steps.acr-login.outputs.acr_login_server }}/${{ env.IMAGE_NAME }}:latest"
          echo "    - ${{ steps.acr-login.outputs.acr_login_server }}/${{ env.IMAGE_NAME }}:${{ env.ENVIRONMENT }}-latest"
          echo ""
          echo "Next Steps to Update Container App:"
          echo "1. Use the command below to update the Container App with the latest image:"
          echo ""
          echo "   az containerapp update \\"
          echo "     --resource-group <resource-group-name> \\"
          echo "     --name <container-app-name> \\"
          echo "     --image ${{ steps.acr-login.outputs.acr_login_server }}/${{ env.IMAGE_NAME }}:latest"
