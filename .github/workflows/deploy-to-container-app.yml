name: Deploy to Azure Container App

on:
#   workflow_run:
#     workflows: ["Docker Build & Push to ACR"]
#     types:
#       - completed
  workflow_dispatch:
    inputs:
      environment:
        description: "Select the environment"
        required: true
        type: choice
        options:
          - dev
          - stg
          - prd

      who_deploys:
        description: "Who is deploying?"
        required: true
        type: choice
        options:
          - Leela
          - Sandosh

permissions:
  id-token: write
  contents: read

env:
  REGISTRY_NAME: westus2devacr
  IMAGE_NAME: currency-dashboard
  APP_NAME: le-app
  REGION: westus2
  CONTAINER_APP: le-app-westus2-dev-aca
  RESOURCE_GROUP: le-app-westus2-dev-rg

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    env:
      ENVIRONMENT: ${{ github.event.inputs.environment || 'dev' }}
    
    steps:
      # -------------------------
      # Checkout
      # -------------------------
      - uses: actions/checkout@v4

      # -------------------------
      # Azure Login (OIDC)
      # -------------------------
      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ vars.ARM_CLIENT_ID }}
          tenant-id: ${{ vars.ARM_TENANT_ID }}
          subscription-id: ${{ vars.ARM_SUBSCRIPTION_ID }}

      # -------------------------
      # Get ACR login server
      # -------------------------
      - name: Get ACR login server
        id: acr
        run: |
          ACR_LOGIN_SERVER=$(az acr show \
            --name "${REGISTRY_NAME}" \
            --query loginServer -o tsv)
          
          echo "acr_login_server=${ACR_LOGIN_SERVER}" >> $GITHUB_OUTPUT
          echo "ACR Login Server: ${ACR_LOGIN_SERVER}"

    #   # -------------------------
    #   # Get latest image tag
    #   # -------------------------
    #   - name: Get latest image tag
    #     id: image
    #     run: |
    #       # Get the latest tag from ACR
    #       TAG=$(az acr repository show-tags \
    #         --name "${REGISTRY_NAME}" \
    #         --repository "${IMAGE_NAME}" \
    #         --orderby time_desc \
    #         --top 1 \
    #         -o tsv)
          
    #       if [ -z "$TAG" ]; then
    #         echo "Error: No image tags found in ACR"
    #         exit 1
    #       fi
          
    #       IMAGE_URI="${{ steps.acr.outputs.acr_login_server }}/${IMAGE_NAME}:${TAG}"
          
    #       echo "image_tag=${TAG}" >> $GITHUB_OUTPUT
    #       echo "image_uri=${IMAGE_URI}" >> $GITHUB_OUTPUT
    #       echo "Latest image: ${IMAGE_URI}"


      # -------------------------
      # Update Container App image
      # -------------------------
      - name: Update Container App
        run: |
          az containerapp update \
            --name "${{ env.CONTAINER_APP }}" \
            --resource-group "${{ env.RESOURCE_GROUP }}" \
            --image "${{ steps.acr.outputs.acr_login_server }}/${{ env.IMAGE_NAME }}:latest" \
            --registry-server "${{ steps.acr.outputs.acr_login_server }}" \
            --registry-username "${{ vars.ACR_USERNAME }}" \
            --registry-password "${{ secrets.ACR_PASSWORD }}" \
            --set-env-vars DEPLOYED_AT="$(date -u +'%Y-%m-%dT%H:%M:%SZ')" SOURCE_TAG="latest"

      # -------------------------
      # Verify deployment
      # -------------------------
      - name: Verify deployment
        run: |
          echo "Waiting for Container App to be ready..."
          sleep 10
          
          # Get the current image
          CURRENT_IMAGE=$(az containerapp show \
            --name "${{ env.CONTAINER_APP }}" \
            --resource-group "${{ env.RESOURCE_GROUP }}" \
            --query "properties.template.containers[0].image" -o tsv)
          
          echo "Current image deployed: ${CURRENT_IMAGE}"
          
          # Get the app URL
          APP_URL=$(az containerapp show \
            --name "${{ env.CONTAINER_APP }}" \
            --resource-group "${{ env.RESOURCE_GROUP }}" \
            --query "properties.ingress.fqdn" -o tsv)
          
          echo "App URL: https://${APP_URL}"

      # -------------------------
      # Deployment summary
      # -------------------------
      - name: Deployment Summary
        run: |
          cat << EOF
          =====================================
          Deployment Summary
          =====================================
          Environment:    ${{ env.ENVIRONMENT }}
          Container App:  ${{ env.CONTAINER_APP }}
          Resource Group: ${{ env.RESOURCE_GROUP }}
          Image:          ${{ steps.acr.outputs.acr_login_server }}/${{ env.IMAGE_NAME }}:latest
          Status:         âœ“ Deployment Complete
          =====================================
          EOF
